name: Deploy MooseMatrix (Prod)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push image
        run: |
          TS=$(date +%Y%m%d-%H%M%S)
          echo "TS=$TS" >> $GITHUB_ENV
          IMAGE=ghcr.io/the-moose-man/moosematrix:$TS
          LATEST=ghcr.io/the-moose-man/moosematrix:latest
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          docker build -t $IMAGE -t $LATEST .
          docker push $IMAGE
          docker push $LATEST

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            BASE_NAME="moosematrix-app"
            NEW_NAME="moosematrix-app-${TS}"
            IMAGE="${IMAGE}"

            echo "üì• Pulling latest image..."
            docker pull $IMAGE

            echo "üöÄ Starting new container: $NEW_NAME"
            docker run -d \
              --name $NEW_NAME \
              --network moose-prod-net \
              $IMAGE

            echo "ü©∫ Health check (5 attempts)..."
            for i in {1..5}; do
              if docker run --rm --network moose-prod-net curlimages/curl:8.8.0 \
                curl -sf http://$NEW_NAME:3000 > /dev/null; then
                echo "‚úÖ $NEW_NAME is healthy"
                break
              fi
              echo "‚è≥ Waiting for app... ($i/5)"
              sleep 5
            done

            if ! docker run --rm --network moose-prod-net curlimages/curl:8.8.0 \
              curl -sf http://$NEW_NAME:3000 > /dev/null; then
              echo "‚ùå $NEW_NAME failed health check. Keeping old container."
              docker logs $NEW_NAME
              docker rm -f $NEW_NAME
              exit 1
            fi

            echo "‚ôªÔ∏è Switching alias..."
            docker rm -f $BASE_NAME || true
            docker stop $NEW_NAME
            docker rename $NEW_NAME $BASE_NAME

            echo "üßπ Cleaning up old containers..."
            docker ps -a --filter "name=moosematrix-app-" --format "{{.Names}}" \
              | grep -v $BASE_NAME | xargs -r docker rm -f

            echo "üßπ Keeping only last 5 images..."
            docker images "ghcr.io/the-moose-man/moosematrix" --format "{{.Repository}}:{{.Tag}}" \
              | grep -v latest | sort -r \
              | tail -n +6 | xargs -r docker rmi

            echo "‚úÖ Prod deployment complete ‚Üí https://moosematrix.com"
